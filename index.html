<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enredo | Harmonics Pro v6.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js & Post-Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/BokehShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/BokehPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f0f0f;
            --panel-bg: rgba(20, 20, 20, 0.85);
            --input-bg: #252525;
            --text-main: #EAEAEA;
            --text-muted: #888888;
            --accent: #00FFDA;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: #020202;
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* --- MODERN UI CONTAINER --- */
        #ui-container {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            width: 320px;
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
            background: var(--panel-bg);
            backdrop-filter: blur(24px) saturate(120%);
            -webkit-backdrop-filter: blur(24px) saturate(120%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
            z-index: 100;
        }
        
        #ui-container.hidden-ui {
            transform: translateX(-120%);
            opacity: 0;
            pointer-events: none;
        }

        #ui-container::-webkit-scrollbar { width: 4px; }
        #ui-container::-webkit-scrollbar-track { background: transparent; }
        #ui-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* Header */
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        h1 { font-size: 0.85rem; font-weight: 600; letter-spacing: 0.02em; color: var(--text-main); margin: 0; }
        .brand-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px var(--accent); }

        h2 { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 1.2rem 0 0.8rem 0; }

        .control-group { margin-bottom: 1rem; }

        .label-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; margin-bottom: 0.5rem; color: var(--text-main); }
        .value-display { font-family: 'ui-monospace', monospace; color: var(--accent); background: rgba(0, 255, 218, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

        /* Modern Sliders */
        input[type="range"] { width: 100%; -webkit-appearance: none; background: transparent; height: 24px; cursor: pointer; display: block; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--input-bg); border-radius: 2px; border: 1px solid rgba(255,255,255,0.05); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); border: 2px solid var(--bg-dark); transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); background: var(--accent); }

        .segmented-control { display: flex; background: var(--input-bg); padding: 3px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1rem; }
        .segment-btn { flex: 1; background: transparent; border: none; color: var(--text-muted); padding: 6px 0; font-size: 0.7rem; font-weight: 500; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .segment-btn:hover { color: var(--text-main); }
        .segment-btn.active { background: #444; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .action-btn { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 0.5rem; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-btn:hover { background: #333; border-color: rgba(255,255,255,0.2); }
        .action-btn.primary { background: rgba(0, 255, 218, 0.1); color: var(--accent); border-color: rgba(0, 255, 218, 0.3); }
        .action-btn.primary:hover { background: rgba(0, 255, 218, 0.2); }

        #show-ui-btn { position: absolute; top: 1.5rem; left: 1.5rem; width: 40px; height: 40px; background: rgba(20, 20, 20, 0.5); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 50%; color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
        #show-ui-btn.visible { opacity: 1; pointer-events: auto; }
        #show-ui-btn:hover { background: var(--input-bg); }

        #shortcut-hint { position: fixed; bottom: 2rem; right: 2rem; font-size: 0.7rem; color: rgba(255,255,255,0.2); pointer-events: none; }
    </style>
</head>
<body>

    <button id="show-ui-btn" onclick="toggleUI()" title="Show Settings (H)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>

    <div id="ui-container">
        <div class="panel-header">
            <h1><span class="brand-dot"></span>Harmonics <span style="opacity:0.5; font-weight:400;">Pro</span></h1>
            <button onclick="toggleUI()" style="color: var(--text-muted); background:none; border:none; cursor:pointer;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>

        <div class="control-group">
            <div style="position: relative;">
                <select id="geoMode" style="width:100%; background:var(--input-bg); color:white; border:1px solid var(--border-color); padding:8px 12px; border-radius:8px; font-size:0.75rem; outline:none; appearance:none; cursor:pointer;">
                    <option value="liquid">Líquido (Ultra Smooth)</option>
                    <option value="ribbon">Fita (Flat/Nó)</option>
                    <option value="tube">Tubo (Vidro Padrão)</option>
                    <option value="swarm">Enxame (Malha Densa)</option>
                    <option value="quantum">Quantum (Partículas)</option>
                    <option value="portal">Portal (Vortex)</option>
                </select>
                <div style="position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; font-size:0.6rem; color:gray;">▼</div>
            </div>
        </div>

        <!-- CÂMERA & FOCO -->
        <h2>Lente & Foco</h2>
        
        <div class="segmented-control">
            <button class="segment-btn active" onclick="setCamMode('free')" id="btn-cam-free">Livre</button>
            <button class="segment-btn" onclick="setCamMode('auto')" id="btn-cam-auto">Orbit</button>
            <button class="segment-btn" onclick="setCamMode('2d')" id="btn-cam-2d">Flat</button>
        </div>

        <div class="control-group">
            <div class="label-row"><label>Distância Focal</label><span id="val-focus" class="value-display">25.0</span></div>
            <input type="range" id="focus" min="10" max="150" step="0.5" value="25">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Abertura (Blur)</label><span id="val-aperture" class="value-display">0.01</span></div>
            <input type="range" id="aperture" min="0" max="0.1" step="0.001" value="0.01">
        </div>

        <!-- GEOMETRIA -->
        <h2>Geometria</h2>
        <div class="control-group">
            <div class="label-row"><label>Densidade</label><span id="val-count" class="value-display">5</span></div>
            <input type="range" id="count" min="1" max="200" value="5">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Defasagem</label><span id="val-spread" class="value-display">20%</span></div>
            <input type="range" id="spread" min="0" max="100" value="20">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Resolução</label><span id="val-tubularSegments" class="value-display">400</span></div>
            <input type="range" id="tubularSegments" min="50" max="1000" step="10" value="400">
        </div>

        <!-- FORMA -->
        <h2>Forma</h2>
        <div class="control-group">
            <div class="label-row"><label>Espessura</label><span id="val-thickness" class="value-display">2.5</span></div>
            <input type="range" id="thickness" min="0.02" max="5.0" step="0.02" value="2.5">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Torção</label><span id="val-twist" class="value-display">5</span></div>
            <input type="range" id="twist" min="0" max="20" step="1" value="5">
        </div>

        <!-- DINÂMICA (Readicionado) -->
        <h2>Dinâmica</h2>
        <div class="control-group">
            <div class="label-row"><label>Velocidade</label><span id="val-speed" class="value-display">0.3</span></div>
            <input type="range" id="speed" min="0" max="5" step="0.1" value="0.3">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Inclinação</label><span id="val-tilt" class="value-display">30°</span></div>
            <input type="range" id="tilt" min="0" max="180" value="30">
        </div>

        <!-- MATERIAL -->
        <h2>Material</h2>
        <div class="control-group">
            <div class="label-row"><label>Transmissão</label><span id="val-transmission" class="value-display">0.98</span></div>
            <input type="range" id="transmission" min="0" max="1" step="0.01" value="0.98">
        </div>
        <div class="control-group">
            <div class="label-row"><label>Rugosidade</label><span id="val-roughness" class="value-display">0.05</span></div>
            <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.05">
        </div>

        <!-- HIDDEN PARAMS -->
        <input type="hidden" id="radius" value="15">
        <input type="hidden" id="chaos" value="0">

        <div style="margin-top: 2rem;">
            <button id="macro-btn" class="action-btn" onclick="toggleMacroMode()">
                Macro Foco (Luz)
            </button>
            <button class="action-btn" onclick="randomize()">Gerar Variação (Wild)</button>
            <button class="action-btn primary" onclick="exportHighResFrame()">Exportar Frame 4K</button>
        </div>
    </div>

    <div id="shortcut-hint">Pressione 'H' para UI • 'F' para Foco no Mouse</div>

    <script>
        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);

        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 5, 300); 
        camera.position.set(40, 20, 60);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); 
        renderer.physicallyCorrectLights = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; 
        controls.dampingFactor = 0.05;
        controls.enabled = true; 

        // --- COMPOSITOR ---
        const composer = new THREE.EffectComposer(renderer);
        const renderPass = new THREE.RenderPass(scene, camera);
        composer.addPass(renderPass);

        const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.7; bloomPass.strength = 0.4; bloomPass.radius = 0.2;
        composer.addPass(bloomPass);

        const bokehPass = new THREE.BokehPass(scene, camera, {
            focus: 25.0, aperture: 0.01, maxblur: 0.1,
            width: window.innerWidth, height: window.innerHeight
        });
        composer.addPass(bokehPass);

        // --- LUZES ---
        const keyLight = new THREE.SpotLight(0x00FFDA, 4000);
        keyLight.position.set(30, 40, 20); keyLight.angle = Math.PI / 8; keyLight.penumbra = 0.2;
        keyLight.castShadow = true; 
        keyLight.shadow.mapSize.width = 2048; keyLight.shadow.mapSize.height = 2048;
        keyLight.shadow.bias = -0.0001; 
        scene.add(keyLight);

        const rimLight = new THREE.SpotLight(0xffffff, 3000);
        rimLight.position.set(-30, 10, -40); rimLight.angle = Math.PI / 4; rimLight.penumbra = 0.5;
        scene.add(rimLight);

        const fillLight = new THREE.RectAreaLight(0x0044aa, 300, 50, 50);
        fillLight.position.set(0, -50, 50); fillLight.lookAt(0,0,0);
        scene.add(fillLight);

        // --- ESTADO ---
        const state = {
            geoMode: 'liquid', count: 5, spread: 0.2, radius: 15, thickness: 2.5, twist: 5,
            tubularSegments: 400, speed: 0.3, tilt: 30 * Math.PI/180, chaos: 0,
            transmission: 0.98, roughness: 0.05, viewMode: 'free', macroMode: false
        };

        const ringGroup = new THREE.Group();
        scene.add(ringGroup);
        let rings = [];

        const glassMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x00FFDA, metalness: 0.0, roughness: state.roughness, transmission: state.transmission, 
            ior: 1.5, thickness: 3.0, clearcoat: 1.0, clearcoatRoughness: 0.02, side: THREE.DoubleSide, transparent: true, envMapIntensity: 1.5 
        });

        function createSystem() {
            ringGroup.children.forEach(c => { if(c.geometry) c.geometry.dispose(); });
            ringGroup.clear();
            rings = [];

            let geometry;
            let activeMaterial = glassMaterial;
            glassMaterial.wireframe = false;

            switch(state.geoMode) {
                case 'liquid': geometry = new THREE.TorusKnotGeometry(state.radius, state.thickness, state.tubularSegments, 128, Math.max(2, state.twist), 5); break;
                case 'tube': geometry = new THREE.TorusGeometry(state.radius, state.thickness, 128, state.tubularSegments); break;
                case 'ribbon': 
                    geometry = new THREE.TorusKnotGeometry(state.radius, state.thickness, state.tubularSegments, 8, Math.max(1, state.twist), 3);
                    geometry.scale(1, 1, 0.05); break;
            }
            if (state.geoMode === 'portal') geometry = new THREE.TorusGeometry(state.radius, state.thickness, 128, state.tubularSegments);
            if (['swarm', 'quantum'].includes(state.geoMode)) {
                 geometry = new THREE.TorusGeometry(state.radius, state.thickness, 16, 64);
                 activeMaterial = new THREE.MeshBasicMaterial({color: 0x00FFDA, wireframe: true, opacity:0.3, transparent:true});
            }

            for (let i = 0; i < state.count; i++) {
                const mesh = new THREE.Mesh(geometry, activeMaterial.clone());
                mesh.userData = { id: i, phaseOffset: Math.random() * 100, randomSpeed: Math.random() * 0.5 + 0.5 };
                mesh.castShadow = true; mesh.receiveShadow = true;
                if (state.geoMode === 'ribbon') mesh.rotation.x = Math.PI / 2;
                if (!['swarm', 'quantum'].includes(state.geoMode)) {
                    mesh.material.roughness = state.roughness;
                    mesh.material.transmission = state.transmission;
                }
                ringGroup.add(mesh);
                rings.push(mesh);
            }
        }
        createSystem();

        // --- ANIMAÇÃO ---
        let time = 0;
        function animate() {
            time += state.speed * 0.005;
            rings.forEach((ring, i) => {
                const nIndex = i / Math.max(1, state.count -1);
                let phase = nIndex * state.spread * Math.PI * 2;
                let rotX = (Math.sin(time + phase) * state.tilt) + (state.tilt * 0.5);
                let rotY = (time * 0.3) + phase;
                if (state.geoMode === 'liquid') {
                    rotX += Math.sin(time * 0.7 + i) * 0.3;
                    rotY += Math.cos(time * 0.5 + i) * 0.3;
                    const s = 1 + Math.sin(time*2 + i)*0.05;
                    ring.scale.set(s,s,s);
                }
                ring.rotation.x = rotX;
                ring.rotation.y = rotY;
            });
            ringGroup.rotation.z = time * 0.02;
            
            controls.update(); 
            
            composer.render();
            requestAnimationFrame(animate);
        }

        // --- UI & EVENTOS ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('keydown', (e) => {
            if (e.key === 'f' || e.key === 'F') {
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(ringGroup.children);
                if(intersects.length > 0) {
                    const dist = intersects[0].distance;
                    document.getElementById('focus').value = dist;
                    document.getElementById('focus').dispatchEvent(new Event('input'));
                }
            }
            if (e.key === 'h' || e.key === 'H') toggleUI();
        });

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        function bind(id, key, scale = 1, suffix = '', rebuild = false, mat = false) {
            const el = document.getElementById(id);
            const valEl = document.getElementById('val-' + id);
            el.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                state[key] = val * scale;
                if(valEl) {
                    if(suffix === '%') valEl.innerText = Math.round(val) + suffix;
                    else if(suffix === '°') valEl.innerText = Math.round(val) + suffix;
                    else valEl.innerText = (val * scale).toFixed(3) + suffix;
                }
                if (rebuild) createSystem();
                if (mat && !['swarm', 'quantum', 'portal'].includes(state.geoMode)) {
                    rings.forEach(r => { if(r.material[key] !== undefined) r.material[key] = state[key]; });
                }
                
                if(id === 'focus') bokehPass.uniforms['focus'].value = val;
                if(id === 'aperture') {
                    bokehPass.uniforms['aperture'].value = val;
                    bokehPass.uniforms['maxblur'].value = Math.max(0.02, val * 5.0); 
                }
            });
        }

        document.getElementById('geoMode').addEventListener('change', (e) => {
            state.geoMode = e.target.value;
            createSystem();
        });

        bind('count', 'count', 1, '', true);
        bind('spread', 'spread', 0.01, '%');
        bind('thickness', 'thickness', 1, '', true);
        bind('twist', 'twist', 1, '', true);
        bind('tubularSegments', 'tubularSegments', 1, '', true);
        bind('transmission', 'transmission', 1, '', false, true);
        bind('roughness', 'roughness', 1, '', false, true);
        
        // Re-added Dynamic controls
        bind('speed', 'speed', 1);
        bind('tilt', 'tilt', Math.PI / 180, '°');
        
        bind('focus', 'focus', 1);
        bind('aperture', 'aperture', 1);

        function toggleUI() {
            const ui = document.getElementById('ui-container');
            const btn = document.getElementById('show-ui-btn');
            if (ui.classList.contains('hidden-ui')) { ui.classList.remove('hidden-ui'); btn.classList.remove('visible'); } 
            else { ui.classList.add('hidden-ui'); btn.classList.add('visible'); }
        }

        function setCamMode(mode) {
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-cam-' + mode).classList.add('active');
            
            if(mode === 'auto') {
                controls.autoRotate = true; 
                controls.autoRotateSpeed = 1.0;
            } else if (mode === '2d') {
                controls.autoRotate = false;
                gsap.to(camera.position, {x: 0, y: 0, z: 180, duration: 1.5});
                gsap.to(controls.target, {x: 0, y: 0, z: 0, duration: 1.5});
            } else {
                controls.autoRotate = false;
            }
        }

        function toggleMacroMode() {
            state.macroMode = !state.macroMode;
            const btn = document.getElementById('macro-btn');
            
            if (state.macroMode) {
                btn.classList.add('primary');
                gsap.to(camera.position, { duration: 1.5, x: 15, y: 10, z: 20, ease: "power2.inOut" });
                gsap.to(bokehPass.uniforms['aperture'], { value: 0.005, duration: 1 }); 
                gsap.to(bokehPass.uniforms['maxblur'], { value: 0.02, duration: 1 });
            } else {
                btn.classList.remove('primary');
                gsap.to(camera.position, { duration: 1.5, x: 40, y: 20, z: 60, ease: "power2.inOut" });
                gsap.to(bokehPass.uniforms['aperture'], { value: 0.0001, duration: 0.5 });
                gsap.to(bokehPass.uniforms['maxblur'], { value: 0.0, duration: 0.5 });
            }
        }

        function randomize() {
            document.getElementById('geoMode').value = 'liquid';
            document.getElementById('geoMode').dispatchEvent(new Event('change'));
            const setVal = (id, v) => { document.getElementById(id).value = v; document.getElementById(id).dispatchEvent(new Event('input')); };
            setVal('twist', Math.floor(Math.random() * 8) + 2);
            setVal('thickness', Math.random() * 1.5 + 1.5);
            setVal('spread', Math.random() * 40);
        }

        function exportHighResFrame() {
            const originalPixelRatio = renderer.getPixelRatio();
            renderer.setPixelRatio(window.devicePixelRatio * 2); 
            composer.setSize(window.innerWidth * 2, window.innerHeight * 2); 
            composer.render();
            const link = document.createElement('a');
            link.download = `Enredo_ProFrame_${Date.now()}.png`;
            link.href = renderer.domElement.toDataURL('image/png', 1.0); 
            link.click();
            renderer.setPixelRatio(originalPixelRatio);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            bokehPass.uniforms['aspect'].value = window.innerWidth / window.innerHeight;
        });
        
        animate();
    </script>
</body>
</html>
